3088767c0a8d01e23bdbe2c0a8199cee
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const testing_1 = require("@angular/core/testing");
const testing_2 = require("@angular/common/http/testing");
const auth_jwt_service_1 = require("app/core/auth/auth-jwt.service");
const ngx_webstorage_1 = require("ngx-webstorage");
describe('Auth JWT', () => {
    let service;
    let localStorageService;
    let sessionStorageService;
    let httpMock;
    beforeEach(() => {
        testing_1.TestBed.configureTestingModule({
            imports: [testing_2.HttpClientTestingModule, ngx_webstorage_1.NgxWebstorageModule.forRoot()],
        });
        httpMock = testing_1.TestBed.inject(testing_2.HttpTestingController);
        service = testing_1.TestBed.inject(auth_jwt_service_1.AuthServerProvider);
        localStorageService = testing_1.TestBed.inject(ngx_webstorage_1.LocalStorageService);
        sessionStorageService = testing_1.TestBed.inject(ngx_webstorage_1.SessionStorageService);
    });
    describe('Get Token', () => {
        it('should return empty token if not found in local storage nor session storage', () => {
            const result = service.getToken();
            expect(result).toEqual('');
        });
        it('should return token from session storage if local storage is empty', () => {
            sessionStorageService.retrieve = jest.fn().mockReturnValue('sessionStorageToken');
            const result = service.getToken();
            expect(result).toEqual('sessionStorageToken');
        });
        it('should return token from localstorage storage', () => {
            localStorageService.retrieve = jest.fn().mockReturnValue('localStorageToken');
            const result = service.getToken();
            expect(result).toEqual('localStorageToken');
        });
    });
    describe('Login', () => {
        it('should clear session storage and save in local storage when rememberMe is true', () => {
            // GIVEN
            localStorageService.store = jest.fn();
            sessionStorageService.clear = jest.fn();
            // WHEN
            service.login({ username: 'John', password: '123', rememberMe: true }).subscribe();
            httpMock.expectOne('api/authenticate').flush({ id_token: '1' });
            // THEN
            httpMock.verify();
            expect(localStorageService.store).toHaveBeenCalledWith('authenticationToken', '1');
            expect(sessionStorageService.clear).toHaveBeenCalled();
        });
        it('should clear local storage and save in session storage when rememberMe is false', () => {
            // GIVEN
            sessionStorageService.store = jest.fn();
            localStorageService.clear = jest.fn();
            // WHEN
            service.login({ username: 'John', password: '123', rememberMe: false }).subscribe();
            httpMock.expectOne('api/authenticate').flush({ id_token: '1' });
            // THEN
            httpMock.verify();
            expect(sessionStorageService.store).toHaveBeenCalledWith('authenticationToken', '1');
            expect(localStorageService.clear).toHaveBeenCalled();
        });
    });
    describe('Logout', () => {
        it('should clear storage', () => {
            // GIVEN
            sessionStorageService.clear = jest.fn();
            localStorageService.clear = jest.fn();
            // WHEN
            service.logout().subscribe();
            // THEN
            expect(localStorageService.clear).toHaveBeenCalled();
            expect(sessionStorageService.clear).toHaveBeenCalled();
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2FraGlsc2luZ2gvRGVza3RvcC9Qcm9qZWN0cy93ZWRkaW5nL3NyYy9tYWluL3dlYmFwcC9hcHAvY29yZS9hdXRoL2F1dGgtand0LnNlcnZpY2Uuc3BlYy50cyIsIm1hcHBpbmdzIjoiOztBQUFBLG1EQUFnRDtBQUNoRCwwREFBOEY7QUFDOUYscUVBQW9FO0FBQ3BFLG1EQUFpRztBQUVqRyxRQUFRLENBQUMsVUFBVSxFQUFFLEdBQUcsRUFBRTtJQUN4QixJQUFJLE9BQTJCLENBQUM7SUFDaEMsSUFBSSxtQkFBd0MsQ0FBQztJQUM3QyxJQUFJLHFCQUE0QyxDQUFDO0lBQ2pELElBQUksUUFBK0IsQ0FBQztJQUVwQyxVQUFVLENBQUMsR0FBRyxFQUFFO1FBQ2QsaUJBQU8sQ0FBQyxzQkFBc0IsQ0FBQztZQUM3QixPQUFPLEVBQUUsQ0FBQyxpQ0FBdUIsRUFBRSxvQ0FBbUIsQ0FBQyxPQUFPLEVBQUUsQ0FBQztTQUNsRSxDQUFDLENBQUM7UUFFSCxRQUFRLEdBQUcsaUJBQU8sQ0FBQyxNQUFNLENBQUMsK0JBQXFCLENBQUMsQ0FBQztRQUNqRCxPQUFPLEdBQUcsaUJBQU8sQ0FBQyxNQUFNLENBQUMscUNBQWtCLENBQUMsQ0FBQztRQUM3QyxtQkFBbUIsR0FBRyxpQkFBTyxDQUFDLE1BQU0sQ0FBQyxvQ0FBbUIsQ0FBQyxDQUFDO1FBQzFELHFCQUFxQixHQUFHLGlCQUFPLENBQUMsTUFBTSxDQUFDLHNDQUFxQixDQUFDLENBQUM7SUFDaEUsQ0FBQyxDQUFDLENBQUM7SUFFSCxRQUFRLENBQUMsV0FBVyxFQUFFLEdBQUcsRUFBRTtRQUN6QixFQUFFLENBQUMsNkVBQTZFLEVBQUUsR0FBRyxFQUFFO1lBQ3JGLE1BQU0sTUFBTSxHQUFHLE9BQU8sQ0FBQyxRQUFRLEVBQUUsQ0FBQztZQUNsQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQzdCLENBQUMsQ0FBQyxDQUFDO1FBRUgsRUFBRSxDQUFDLG9FQUFvRSxFQUFFLEdBQUcsRUFB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QUM7WUFDeEMsbUJBQW1CLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQztZQUV0QyxPQUFPO1lBQ1AsT0FBTyxDQUFDLE1BQU0sRUFBRSxDQUFDLFNBQVMsRUFBRSxDQUFDO1lBRTdCLE9BQU87WUFDUCxNQUFNLENBQUMsbUJBQW1CLENBQUMsS0FBSyxDQUFDLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztZQUNyRCxNQUFNLENBQUMscUJBQXFCLENBQUMsS0FBSyxDQUFDLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztRQUN6RCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL2FraGlsc2luZ2gvRGVza3RvcC9Qcm9qZWN0cy93ZWRkaW5nL3NyYy9tYWluL3dlYmFwcC9hcHAvY29yZS9hdXRoL2F1dGgtand0LnNlcnZpY2Uuc3BlYy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBUZXN0QmVkIH0gZnJvbSAnQGFuZ3VsYXIvY29yZS90ZXN0aW5nJztcbmltcG9ydCB7IEh0dHBDbGllbnRUZXN0aW5nTW9kdWxlLCBIdHRwVGVzdGluZ0NvbnRyb2xsZXIgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cC90ZXN0aW5nJztcbmltcG9ydCB7IEF1dGhTZXJ2ZXJQcm92aWRlciB9IGZyb20gJ2FwcC9jb3JlL2F1dGgvYXV0aC1qd3Quc2VydmljZSc7XG5pbXBvcnQgeyBMb2NhbFN0b3JhZ2VTZXJ2aWNlLCBOZ3hXZWJzdG9yYWdlTW9kdWxlLCBTZXNzaW9uU3RvcmFnZVNlcnZpY2UgfSBmcm9tICduZ3gtd2Vic3RvcmFnZSc7XG5cbmRlc2NyaWJlKCdBdXRoIEpXVCcsICgpID0+IHtcbiAgbGV0IHNlcnZpY2U6IEF1dGhTZXJ2ZXJQcm92aWRlcjtcbiAgbGV0IGxvY2FsU3RvcmFnZVNlcnZpY2U6IExvY2FsU3RvcmFnZVNlcnZpY2U7XG4gIGxldCBzZXNzaW9uU3RvcmFnZVNlcnZpY2U6IFNlc3Npb25TdG9yYWdlU2VydmljZTtcbiAgbGV0IGh0dHBNb2NrOiBIdHRwVGVzdGluZ0NvbnRyb2xsZXI7XG5cbiAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgVGVzdEJlZC5jb25maWd1cmVUZXN0aW5nTW9kdWxlKHtcbiAgICAgIGltcG9ydHM6IFtIdHRwQ2xpZW50VGVzdGluZ01vZHVsZSwgTmd4V2Vic3RvcmFnZU1vZHVsZS5mb3JSb290KCldLFxuICAgIH0pO1xuXG4gICAgaHR0cE1vY2sgPSBUZXN0QmVkLmluamVjdChIdHRwVGVzdGluZ0NvbnRyb2xsZXIpO1xuICAgIHNlcnZpY2UgPSBUZXN0QmVkLmluamVjdChBdXRoU2VydmVyUHJvdmlkZXIpO1xuICAgIGxvY2FsU3RvcmFnZVNlcnZpY2UgPSBUZXN0QmVkLmluamVjdChMb2NhbFN0b3JhZ2VTZXJ2aWNlKTtcbiAgICBzZXNzaW9uU3RvcmFnZVNlcnZpY2UgPSBUZXN0QmVkLmluamVjdChTZXNzaW9uU3RvcmFnZVNlcnZpY2UpO1xuICB9KTtcblxuICBkZXNjcmliZSgnR2V0IFRva2VuJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgcmV0dXJuIGVtcHR5IHRva2VuIGlmIG5vdCBmb3VuZCBpbiBsb2NhbCBzdG9yYWdlIG5vciBzZXNzaW9uIHN0b3JhZ2UnLCAoKSA9PiB7XG4gICAgICBjb25zdCByZXN1bHQgPSBzZXJ2aWNlLmdldFRva2VuKCk7XG4gICAgICBleHBlY3QocmVzdWx0KS50b0VxdWFsKCcnKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgcmV0dXJuIHRva2VuIGZyb20gc2Vzc2lvbiBzdG9yYWdlIGlmIGxvY2FsIHN0b3JhZ2UgaXMgZW1wdHknLCAoKSA9PiB7XG4gICAgICBzZXNzaW9uU3RvcmFnZVNlcnZpY2UucmV0cmlldmUgPSBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKCdzZXNzaW9uU3RvcmFnZVRva2VuJyk7XG4gICAgICBjb25zdCByZXN1bHQgPSBzZXJ2aWNlLmdldFRva2VuKCk7XG4gICAgICBleHBlY3QocmVzdWx0KS50b0VxdWFsKCdzZXNzaW9uU3RvcmFnZVRva2VuJyk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHJldHVybiB0b2tlbiBmcm9tIGxvY2Fsc3RvcmFnZSBzdG9yYWdlJywgKCkgPT4ge1xuICAgICAgbG9jYWxTdG9yYWdlU2VydmljZS5yZXRyaWV2ZSA9IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUoJ2xvY2FsU3RvcmFnZVRva2VuJyk7XG4gICAgICBjb25zdCByZXN1bHQgPSBzZXJ2aWNlLmdldFRva2VuKCk7XG4gICAgICBleHBlY3QocmVzdWx0KS50b0VxdWFsKCdsb2NhbFN0b3JhZ2VUb2tlbicpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnTG9naW4nLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBjbGVhciBzZXNzaW9uIHN0b3JhZ2UgYW5kIHNhdmUgaW4gbG9jYWwgc3RvcmFnZSB3aGVuIHJlbWVtYmVyTWUgaXMgdHJ1ZScsICgpID0+IHtcbiAgICAgIC8vIEdJVkVOXG4gICAgICBsb2NhbFN0b3JhZ2VTZXJ2aWNlLnN0b3JlID0gamVzdC5mbigpO1xuICAgICAgc2Vzc2lvblN0b3JhZ2VTZXJ2aWNlLmNsZWFyID0gamVzdC5mbigpO1xuXG4gICAgICAvLyBXSEVOXG4gICAgICBzZXJ2aWNlLmxvZ2luKHsgdXNlcm5hbWU6ICdKb2huJywgcGFzc3dvcmQ6ICcxMjMnLCByZW1lbWJlck1lOiB0cnVlIH0pLnN1YnNjcmliZSgpO1xuICAgICAgaHR0cE1vY2suZXhwZWN0T25lKCdhcGkvYXV0aGVudGljYXRlJykuZmx1c2goeyBpZF90b2tlbjogJzEnIH0pO1xuXG4gICAgICAvLyBUSEVOXG4gICAgICBodHRwTW9jay52ZXJpZnkoKTtcbiAgICAgIGV4cGVjdChsb2NhbFN0b3JhZ2VTZXJ2aWNlLnN0b3JlKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCgnYXV0aGVudGljYXRpb25Ub2tlbicsICcxJyk7XG4gICAgICBleHBlY3Qoc2Vzc2lvblN0b3JhZ2VTZXJ2aWNlLmNsZWFyKS50b0hhdmVCZWVuQ2FsbGVkKCk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGNsZWFyIGxvY2FsIHN0b3JhZ2UgYW5kIHNhdmUgaW4gc2Vzc2lvbiBzdG9yYWdlIHdoZW4gcmVtZW1iZXJNZSBpcyBmYWxzZScsICgpID0+IHtcbiAgICAgIC8vIEdJVkVOXG4gICAgICBzZXNzaW9uU3RvcmFnZVNlcnZpY2Uuc3RvcmUgPSBqZXN0LmZuKCk7XG4gICAgICBsb2NhbFN0b3JhZ2VTZXJ2aWNlLmNsZWFyID0gamVzdC5mbigpO1xuXG4gICAgICAvLyBXSEVOXG4gICAgICBzZXJ2aWNlLmxvZ2luKHsgdXNlcm5hbWU6ICdKb2huJywgcGFzc3dvcmQ6ICcxMjMnLCByZW1lbWJlck1lOiBmYWxzZSB9KS5zdWJzY3JpYmUoKTtcbiAgICAgIGh0dHBNb2NrLmV4cGVjdE9uZSgnYXBpL2F1dGhlbnRpY2F0ZScpLmZsdXNoKHsgaWRfdG9rZW46ICcxJyB9KTtcblxuICAgICAgLy8gVEhFTlxuICAgICAgaHR0cE1vY2sudmVyaWZ5KCk7XG4gICAgICBleHBlY3Qoc2Vzc2lvblN0b3JhZ2VTZXJ2aWNlLnN0b3JlKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCgnYXV0aGVudGljYXRpb25Ub2tlbicsICcxJyk7XG4gICAgICBleHBlY3QobG9jYWxTdG9yYWdlU2VydmljZS5jbGVhcikudG9IYXZlQmVlbkNhbGxlZCgpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnTG9nb3V0JywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgY2xlYXIgc3RvcmFnZScsICgpID0+IHtcbiAgICAgIC8vIEdJVkVOXG4gICAgICBzZXNzaW9uU3RvcmFnZVNlcnZpY2UuY2xlYXIgPSBqZXN0LmZuKCk7XG4gICAgICBsb2NhbFN0b3JhZ2VTZXJ2aWNlLmNsZWFyID0gamVzdC5mbigpO1xuXG4gICAgICAvLyBXSEVOXG4gICAgICBzZXJ2aWNlLmxvZ291dCgpLnN1YnNjcmliZSgpO1xuXG4gICAgICAvLyBUSEVOXG4gICAgICBleHBlY3QobG9jYWxTdG9yYWdlU2VydmljZS5jbGVhcikudG9IYXZlQmVlbkNhbGxlZCgpO1xuICAgICAgZXhwZWN0KHNlc3Npb25TdG9yYWdlU2VydmljZS5jbGVhcikudG9IYXZlQmVlbkNhbGxlZCgpO1xuICAgIH0pO1xuICB9KTtcbn0pO1xuIl0sInZlcnNpb24iOjN9